---
layout: post
comments: true
title:  "이펙티브 자바 3/E_동시성"
date:   2019-12-23 00:00:00
author: Gongdel
categories: Book
tags:	 Java Book EffectiveJava
cover:  "/assets/instacode.png"
---
# 동시성 
## 78. 공유 중인 가변 데이터는 동기화해 사용하라.
### 핵심 정리
여러 스레드가 가변 데이터를 공유한다면 그 데이터를 읽고 쓰는 동작은 반드시 동기화해야 한다.  
동기화하지 않으면 한 스레드가 수행한 변경을 다른 스레드가 보지 못할 수도 있다.  
공유되는 가변 데이터를 동기화하는 데 실패하면 응답 불가 상태에 빠지거나 안전 실패로 이어질 수 있다.  
이는 디버깅 난이도가 가장 높은 문제에 속한다.  간헐적이거나 특정 타이밍에만 발생할 수도 있고, VM에 따라 현상이 달라지기도 한다.  
배타적 실행은 필요없고 스레드끼리의 통신만 필요하다면 volatile 한정자만으로 동기화할 수 있다. 다만 올바로 사용하기 까다롭다.

## 79. 과도한 동기화는 피하라.
### 핵심 정리
교착상태와 데이터 훼손을 피하려면 동기화 영역 안에서 외계인 메서드를 절대 호출하지 말자.  
일반화해 이야기하면, 동기화 영역 안에서의 작업은 최소한으로 줄이자. 가변 클래스를 설계할 때는 스스로 동기화해야 할지 고민하자.  
`멀티코어 세상인 지금은 과도한 동기화를 피하는 게 과거 어느 떄보다 중요하다`. 합당한 이유가 있을 때만 내부에서 동기화하고 동기화했는지 여부를 문서에 명확히 밝히자.

## 80. 스레드보다는 실행자(Executor), 태스크, 스트림을 애용하라.  
java.util.concurrent 패키지는 Executor라고 하는 인터페이스 기반의 유연한 테스크 실행 기능을 담고 있다.  

##### 모든 면에서 뛰어난 작업 큐를 다음의 단 한 줄로 생성 할 수 있다.  
~~~java
ExecutorService exec = Executors.newSingleThreadExecutor();
~~~

##### 이 실행자에 태스크(task; 작업)을 넘기는 방법
~~~java
exec.execute(runnable);
~~~

##### 실행자를 종료시키는 방법(이 작업이 실패하면 VM 자체가 종료되지 않는다.)
~~~java
exec.shutdown();
~~~

## 81. wait와 notify보다는 동시성 유틸리티를 애용하라.
### 핵심 정리
wait와 notify를 직접 사용하는 것을 동시성 '어셈블리 언어'로 프로그래밍하는 것에 비유할 수 있다.  
반면 java.util.concurrent는 고수준 언어에 비유할 수 있다. `코드를 새로 작성한다면 wait와 notify를 쓸 이유가 거의(어쩌면 전혀) 없다.`  
이들을 사용하는 레거시 코드를 유지보수 해야 한다면 wait는 항상 표준 관용구에 따라 while 문 안에서 호출하도록 하자.  
일반적으로 notify보다는 notifyAll을 사용해야 한다. 혹시라도 notify를 사용한다면 응답 불가 상태에 빠지지 않도록 각별히 주의하자.

## 82. 스레드 안전성 수준을 문서화하라.
### 핵심 정리
모든 클래스가 자신의 스레드 안전성 정보를 명확히 문서화해야 한다. 정확한 언어로 명확히 설명하거나 스레드 안전성 애너테이션을 사용할 수 있다.  
synchronized 한정자는 문서화와 관련이 없다. 조건부 스레드 안전 클래스는 메서드를 어떤 순서로 호출할 때 외부 동기화가 요구되고, 그떄 어떤 락을 얻어야 하는지도 알려줘야 한다.  
무조건적 스레드 안전 클래스를 작성할 때는 synchronized 메서드가 아닌 비공개 락 객체를 사용하자.  
이렇게 해야 클라이언트나 하위 클래스에서 동기화 메커니즘을 깨드리는 걸 예방할 수 있고, 필요하다면 다음에 더 정교한 동시성을 제어 메커니즘으로 재구현할 여지가 생긴다.

## 83. 지연 초기화는 신중히 사용하라.
### 핵심 정리
대부분의 필드는 지연시키지 말고 곧바로 초기화해야 한다. `성능` 때문에 혹은 `위험한 초기화 순환을 막기 위해` 꼭 지연 초기화를 써야 한다면 올바른 지연 초기화 기법을 사용하자.  
인스턴스 필드에는 이중검사 관용구를, 정적 필드에는 지연 초기화 홀더 클래스 관용구를 사용하자.  
반복해 초기화해도 괜찮은 인스턴스 필드에는 단일검사 관용구도 고려 대상이다.
